<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head lang="en">
		<meta charset="utf-8" />
		<title>雅阁</title>
		<link rel="stylesheet" type="text/css"  href="../css/public.css"/>
		<link rel="stylesheet" type="text/css" href="../css/mygxin.css" />
	</head>
	<body>
	<th:block th:include="webapp/link::link"></th:block>
		<!------------------------------head------------------------------>
		<th:block th:include="webapp/head::userhead"></th:block>
		<!------------------------------idea------------------------------>
		<div class="address mt">
			<div class="wrapper clearfix">
				<a href="/" class="fl">首页</a>
				<span>/</span>
				<a href="/user/index">个人中心</a>
				<span>/</span>
				<a href="/user/address" class="on">地址管理</a>
			</div>
		</div>
		
		<!------------------------------Bott------------------------------>
		<div class="Bott">
			<div class="wrapper clearfix">
				<div class="zuo fl">
					<h3>
						<a href="#"><img src="/img/tx.png"/></a>
						<p class="clearfix"><span class="fl" th:text="${'['+#session.getAttribute('user_session').userName}+']'"></span><span class="fr">[退出登录]</span></p>
					</h3>
					<div>
						<h4>我的交易</h4>
						<ul>
							<li><a href="cart.html">我的购物车</a></li>
							<li><a href="myorderq.html">我的订单</a></li>
							<li><a href="myprod.html">评价晒单</a></li>
						</ul>
						<h4>个人中心</h4>
						<ul>
							<li ><a href="/user/index">我的中心</a></li>
							<li class="on"><a href="/user/address">地址管理</a></li>
						</ul>
						<h4>账户管理</h4>
						<ul>
							<li><a href="mygrxx.html">个人信息</a></li>
							<li><a href="remima.html">修改密码</a></li>
						</ul>
					</div>
				</div>
				<div class="you fl">
					<h2>收货地址</h2>
					<div class="add">
						<div>
							<a href="javascript:void(0)" onclick="addAddress()" id="addxads"><img src="/img/jia.png"/></a>
							<span>添加新地址</span>
						</div>
 					</div>

                    <!--address-->
                    <div class="layui-col-md4" th:each="address: ${addresss}">
                        <div id="dizhi1" style="border: 1px #CCCCCC solid;text-align: left;padding: 10px;margin:10px"  >
                            <p th:text="${address.addressName}">六六六</p>
                            <p th:text="${address.addressTelephone}">1573****666</p>
                            <p th:text="${address.receiverProvince}+' '+${address.receiverCity}+' '+${address.receiverDistrict}">河北省 唐山市 路北区</p>
                            <p th:text="${address.address}">唐山市大学生公寓村（063000）</p>
                            <a th:onclick="update([[${address}]])">修改</a>&nbsp;&nbsp;&nbsp;&nbsp;<a th:onclick="delectAddress([[${address.addressId}]])">删除</a>
                        </div>
                    </div>
                    <!--address-->
                </div>
			</div>
		</div>
		<!--编辑弹框-->
		<!--遮罩-->
		<div class="mask"></div>
		<!--layui 表单-->
		<div id="dis" style="display:none">
			<form class="layui-form" action="" id="formaddress">
				<div class="layui-form-item">
					<label class="layui-form-label">姓名</label>
					<div class="layui-input-inline">
						<input type="text" name="username"  required  lay-verify="required" placeholder="姓名" autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">手机号</label>
					<div class="layui-input-inline">
						<input type="text" name="telephone" required lay-verify="required" placeholder="手机号码" autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item" id="area-picker">
					<div class="layui-form-label">详细地址</div>
					<div class="layui-input-inline" style="width: 200px;">
						<select name="province" class="province-selector" data-value="广东省" lay-filter="province-1">
							<option value="">请选择省</option>
						</select>
					</div>
					<div class="layui-input-inline" style="width: 200px;">
						<select name="city" class="city-selector" data-value="深圳市" lay-filter="city-1">
							<option value="">请选择市</option>
						</select>
					</div>
					<div class="layui-input-inline" style="width: 200px;">
						<select name="county" class="county-selector" data-value="龙岗区" lay-filter="county-1">
							<option value="">请选择区</option>
						</select>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">邮政编码</label>
					<div class="layui-input-inline">
						<input type="text" name="postal" required lay-verify="required" placeholder="邮政编码" autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item layui-form-text" style="width: 500px;">
					<label class="layui-form-label">详细地址</label>
					<div class="layui-input-block">
						<textarea name="address" placeholder="请输入详细地址" class="layui-textarea"></textarea>
					</div>
				</div>
			</form>
		</div>
		<!--返回顶部-->
		<th:block th:replace="webapp/gotop::gotop"></th:block>

		<!--footer-->
		<th:block th:replace="webapp/gotop::footer"></th:block>
		<script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/jquery.validate.min.js"></script>
	<script>
			//一般直接写在一个js文件中
			layui.use(['layer','element'], function(){
				var layer = layui.layer;
                var element = layui.element;
			});

			layui.config({
				base: '/js/mods/'
				, version: '1.0'
			});
		</script>
		<script>
			function address(ajax) {
				layui.use(['layer', 'form', 'layarea'], function(){
					var form = layui.form;
					var layarea = layui.layarea;

					layarea.render({
						elem: '#area-picker',
						data: {
							province: '广东省',
							city: '深圳市',
							county: '龙岗区',
						},
						change: function (res) {
							//选择结果
							console.log(res);
						}
					});

					//监听提交
					form.on('submit(formDemo)', function(data){
						layer.msg(JSON.stringify(data.field));
						return false;
					});
				});


			/**
				 *
				 0: {name: "username", value: ""}
				 1: {name: "telephone", value: ""}
				 2: {name: "province", value: "广东省"}
				 3: {name: "city", value: "深圳市"}
				 4: {name: "county", value: "龙岗区"}
				 5: {name: "postal", value: ""}
				 6：{name: "address", value: ""}
				 */
				layer.open({
					type: 1
					,title:"保存联系人"
					,area:['56%','66%']
					,btn: ['确定', '取消']
					,content: $('#dis')
					,  yes: function(index, layero){
						//表单验证
						var arr = $('#formaddress').serializeArray()
						console.log(arr)
						if(arr[0].value.length < 2  || arr[0].value.length > 20){
							layer.alert("用户名不能小于2个或者大于20个", {icon: 5});
							return;
						}
						var reg = /^1([358][0-9]|4[579]|66|7[0135678]|9[89])[0-9]{8}$/;
						if(!reg.test(arr[1].value)){
							layer.alert("电话号码格式不正确", {icon: 5});
							return;
						}
						var reg2 = /^[1-9][0-9]{5}$/;
						if(!reg2.test(arr[5].value)){
							layer.alert("邮政编码格式不正确", {icon: 5});
							return;
						}
						if(arr[6].value == ""){
							layer.alert("详细地址不能为空", {icon: 5});
							return;
						}
						if(arr[6].value.length >= 30){
							layer.alert("详细地址太长了", {icon: 5});
							return;
						}

						console.log($("#formaddress").serialize())
						$.ajax(
								{
									url:ajax.url,
									type:"POST",
									dataType:"json",
									data:$("#formaddress").serialize()+"&userId=[[${#session.getAttribute('user_session').userId}]]"+ajax.data,
									success:function (result) {
										if(result.errorCode == 'success'){
											layer.alert(result.msg, {icon: 6},function () {
												//刷新
												window.location.reload();
											});
										}
										if(result.errorCode == 'fail'){
											layer.alert(result.msg, {icon: 5});
										}
									}
								}
						)
					},
					btn2: function(index, layero){
						//按钮【按钮二】的回调
						//清空内容
						clear();
					},
					cancel :function () {
						//清空内容
						clear();
					}

				});
			}
			function update(form,userId) {
                /*
		  	address: "湖南科技职业学院暮云校区"
			addressId: 10005
			addressName: "老四"
			addressTelephone: "18512345678"
			postalCode: "419500"
			receiverCity: "长沙市"
			receiverDistrict: "天心区"
			receiverProvince: "湖南省"
			userId: 20
				 */
                $("input[name=username]").val(form.addressName)
				$("input[name=telephone]").val(form.addressTelephone)
				// // $("select[name=province]").attr('data-value',form.receiverProvince)
				// // $("select[name=city]").attr('data-value',form.receiverCity)
				// // $("select[name=county]").attr('data-value',form.receiverDistrict)
				$("input[name=postal]").val(form.postalCode)
				$("textarea[name=address]").val(form.address)
				address({
					url:"/address/update",
					data:"&addresId="+form.addressId,
				});

            }
			
            function clear() {
				$("input[name=username]").val("")
				$("input[name=telephone]").val("")
				$("input[name=postal]").val("")
				$("textarea[name=address]").val("")
			}

            function addAddress() {
				address({
					url:"/address/add",
					data:""
				})
			}
			
			function delectAddress(id) {
				layer.confirm('是否要删除联系人?', {icon: 3, title:'提示'}, function(index){
					//do something
					//删除联系人
					$.ajax(
							{
								url:"/address/delete",
								type:"POST",
								dataType:"json",
								data:{
									addressId:id
								},
								success:function (result) {
									if(result.errorCode == 'success'){
										layer.alert(result.msg, {icon: 6},function () {
											//刷新
											window.location.reload();
										});
									}
									if(result.errorCode == 'fail'){
										layer.alert(result.msg, {icon: 5});
									}
								}
							}
					);
					layer.close(index);
				});
			}
            

		</script>
	</body>
</html>
